package com.chunguang.test;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;

import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

public class TestHttpClient {

	static CloseableHttpClient client = HttpClients.createDefault();
	public static String ua = "Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36";
	public static String video_home = "http://neihanshequ.com/video/";
	public static String home = "http://neihanshequ.com/";
	
	public static Map<String,String> urlMap = new HashMap<String,String>();
	
	
	
	public static void main(String[] args) throws Exception, Exception {
		
//		HttpGet get = new HttpGet("http://i.snssdk.com/neihan/video/playback/?video_id=ddb2c1bcbbbd4dbb9718ca7d194e5475&quality=480p&line=0&is_gif=0.mp4");
//		CloseableHttpResponse res = client.execute(get);
//		InputStream is = res.getEntity().getContent();
//		File storeFile = new File("d:/a.mp4");
//		FileOutputStream output = new FileOutputStream(storeFile);
//		res.getEntity().writeTo(output);
//		System.out.println(landHomePage());
		String home_html = landHomePage();
		
		Document doc = Jsoup.parse(home_html);
		Element contEle = doc.getElementById("detail-list");
		Elements lists = contEle.getAllElements();
		int size = lists.size();
		for (int i = 0; i < size; i++) {
			Element e = lists.get(i);
			Elements content = e.getElementsByClass("content-wrapper");
			if(content.size() == 0) continue;
			String video_url = getVideoUrl(content.get(0));
//			System.out.println(video_url);
			if("".equals(video_url))continue;
//			if(i > 4)
//				break;
			String title = getTitle(content.get(0));
			urlMap.put(video_url, title);
		}
		for (String url : urlMap.keySet()) {
			System.out.println(url + "->" + urlMap.get(url));
			store2File(url, urlMap.get(url));
		}
	}
	
	public static void store2File(String url,String name) throws Exception{
		HttpGet get = new HttpGet(url);
		CloseableHttpResponse res = client.execute(get);
		if("".equals(name))
			name = System.currentTimeMillis()+"";
		File storeFile = new File("E:/ÄÚº­¶Î×ÓÊÓÆµ/"+name+".mp4");
		FileOutputStream output = new FileOutputStream(storeFile);
		res.getEntity().writeTo(output);
	}
	
	public static String getVideoUrl(Element e){
//		Elements content = e.getElementsByClass("detail-list");/
		Element videoContainer = e.getElementById("videoContainer");
		Element player_container = videoContainer.getElementsByClass("player-container").get(0);
		String video_url = player_container.attr("data-src");
		return video_url;
	}
	public static String getTitle(Element e){
		Elements content = e.getElementsByClass("upload-txt");
//		Elements content = e.getElementsByClass("name-time-wrapper left");
		if(content.size() == 0) return "";
		Elements name = content.get(0).getElementsByClass("title");
		if(name.size() == 0) return "";
		String namestr = name.get(0).text();
		return namestr;
	}
	
	public void getPageInfo(){
		
	}
	
	public static String landHomePage(){
		HttpGet get = new HttpGet(home);
		//Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
		//Accept-Encoding:gzip,deflate,sdch
		//Accept-Language:zh-CN,zh;q=0.8
		//Connection:keep-alive
		//Cookie:uuid="w:75b0b8d6e1a44784ba04809a0f9209d9"; Hm_lvt_773f1a5aa45c642cf87eef671e4d3f6a=1494030397; Hm_lpvt_773f1a5aa45c642cf87eef671e4d3f6a=1494030397; csrftoken=9ff2fa6eb10b6e405631a4f7f13f8aad; tt_webid=58549058983
		//Host:neihanshequ.com
		//User-Agent:Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36
		get.addHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8");
		get.addHeader("Accept-Encoding", "gzip,deflate,sdch");
		get.addHeader("Accept-Language", "zh-CN,zh;q=0.8");
		get.addHeader("Connection", "keep-alive");
		get.addHeader("Host", "eihanshequ.com");
		get.addHeader("User-Agent", ua);
		
		try {
			CloseableHttpResponse res = client.execute(get);
			get = new HttpGet(video_home);
			res = client.execute(get);
			return EntityUtils.toString(res.getEntity());
		} catch (ClientProtocolException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return "";
	}
	
	
}
